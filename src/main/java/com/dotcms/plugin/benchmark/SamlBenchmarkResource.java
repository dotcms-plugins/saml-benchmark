package com.dotcms.plugin.benchmark;

import com.dotcms.rest.annotation.NoCache;
import com.dotcms.saml.DotSamlException;
import com.dotcms.saml.DotSamlProxyFactory;
import com.dotcms.saml.IdentityProviderConfiguration;
import com.dotcms.saml.IdentityProviderConfigurationFactory;
import com.dotcms.saml.SamlAuthenticationService;
import com.dotcms.util.CollectionsUtils;
import com.dotcms.util.security.EncryptorFactory;
import com.dotmarketing.business.APILocator;
import com.dotmarketing.portlets.contentlet.business.HostAPI;
import com.dotmarketing.util.Config;
import com.dotmarketing.util.Logger;
import com.dotmarketing.util.UUIDUtil;
import com.dotmarketing.util.UtilMethods;
import com.dotmarketing.util.WebKeys;
import com.liferay.portal.model.User;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriBuilder;
import java.io.IOException;
import java.net.URI;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

/**
 * The idea behind this endpoint will be to:
 * 1) parse the assertion coming from benchmark and retrieve the custom attributes
 * 2) gets login with a benchmark user (created in advance by default and configured under the key: SAML_BENCHMARK_USER_ID)
 * 3) some attributes are encoded in base64, so we need to decode them
 * 4) forward to a page that will display the attributes in a form, the page url is configured under the key: SAML_BENCHMARK_SUCCESS_PATH)
 * @author jsanca
 */
@Path("/v1/dotsaml/")
public class SamlBenchmarkResource {

	private final IdentityProviderConfigurationFactory identityProviderConfigurationFactory;

	private final SamlAuthenticationService samlAuthenticationService;

	private final String successPath = Config.getStringProperty("SAML_BENCHMARK_SUCCESS_PATH", "/Policy-Documents/index");
	private final String benchmarkUserId = Config.getStringProperty("SAML_BENCHMARK_USER_ID", "user-fd06a9a6-cb60-4c53-adc0-751713060687");

	public SamlBenchmarkResource() {

		this.identityProviderConfigurationFactory = DotSamlProxyFactory.getInstance().identityProviderConfigurationFactory();
		this.samlAuthenticationService            = DotSamlProxyFactory.getInstance().samlAuthenticationService();
	}

	@GET // http://localhost:8080/api/v1/dotsaml/benchmark/test
	@Path("/benchmark/test")
	@Consumes({MediaType.APPLICATION_XML, MediaType.APPLICATION_FORM_URLENCODED})
	@Produces( { MediaType.APPLICATION_XML, "text/html" } )
	@NoCache
	public Response processAssertionTest(
								 @Context final HttpServletRequest httpServletRequest,
								 @Context final HttpServletResponse httpServletResponse) throws IOException, ServletException {


		// Extracts data from the assertion - if it can't process a DotSamlException is thrown
		final Map<String, String> encodedAttributesMap =  CollectionsUtils.map("npn", "5323749_",
				"role","agent",
				"email", "thebestuser@example.com",
				"contracts", "W3siY29udHJhY3RfaWQiOiIzMDI5MjgiLCJhZ2VudF9pZCI6MiwibnBuIjoiNTMyMzc0OV8iLCJlbWFpbCI6InRoZWJlc3R1c2VyQGV4YW1wbGUuY29tIiwiZm5hbWUiOiJKb2huIiwibG5hbWUiOiJEb2UiLCJuYW1lIjoiSm9obiBEb2UiLCJhZ2VuY3lfbmFtZSI6IiIsInByb2R1Y3RzIjpbMTQzLDE0NCwxMjkxMF0sInByaW5jaXBhbF9pZCI6MCwidHJhaW5pbmdzIjpbeyJ0cmFpbmluZ190eXBlIjoiTElGRVBSIiwic3RhdGUiOiJOWSIsImNvbXBsZXRlZCI6IjIwMjMtMDYtMjYiLCJleHBpcmF0aW9uIjoiMDAwMC0wMC0wMCIsImluc2VydGVkIjoiMjAyMy0wNi0yNiAwNzo0NDoyMiIsInVwZGF0ZWQiOiIyMDIzLTA2LTI2In0seyJ0cmFpbmluZ190eXBlIjoiU1VJVCIsInN0YXRlIjoiTlkiLCJjb21wbGV0ZWQiOiIyMDIzLTA2LTI2IiwiZXhwaXJhdGlvbiI6IjAwMDAtMDAtMDAiLCJpbnNlcnRlZCI6IjIwMjMtMDYtMjYgMDc6NDQ6MzgiLCJ1cGRhdGVkIjoiMjAyMy0wNi0yNiJ9LHsidHJhaW5pbmdfdHlwZSI6IlNVSVRfTlkiLCJzdGF0ZSI6Ik5ZIiwiY29tcGxldGVkIjoiMjAyMy0wNi0yNiIsImV4cGlyYXRpb24iOiIwMDAwLTAwLTAwIiwiaW5zZXJ0ZWQiOiIyMDIzLTA2LTI2IDA3OjQ0OjM4IiwidXBkYXRlZCI6IjIwMjMtMDYtMjYifV0sIndyaXRpbmdfbnVtYmVycyI6W3siY29tcGFueSI6OTIsImFnZW5jeV9jb2RlIjoiTUE5NSIsIndyaXRpbmciOiJCTUE5NTg5OTkiLCJzdGF0dXMiOiJBQ1QiLCJ0eXBlIjoiUEEiLCJkZWFsX2NvZGUiOiIiLCJsZXZlbF9jbGlmZiI6IiJ9LHsiY29tcGFueSI6OTAsImFnZW5jeV9jb2RlIjoiTUE5NSIsIndyaXRpbmciOiJCTUE5NTg5OTkiLCJzdGF0dXMiOiJBQ1QiLCJ0eXBlIjoiUEEiLCJkZWFsX2NvZGUiOiIiLCJsZXZlbF9jbGlmZiI6IiJ9XSwiYWRkcmVzc19saW5lMSI6IjEyMyBNYWluIFN0IiwiYWRkcmVzc19jaXR5IjoiSG90IFNwcmluZ3MiLCJhZGRyZXNzX3N0YXRlIjoiQVIiLCJhZGRyZXNzX3ppcCI6IjcxOTAxIiwid29ya19waG9uZSI6IjgwMDEyMzQ1NjciLCJjZWxsX3Bob25lIjoiODAwNzY1NDMyMSIsImZheF9waG9uZSI6IiIsIm9yaWdpbl9jb2RlIjoiIiwiZGlzdHJpYnV0aW9uX2NvZGUiOiJCQSIsImRpc3RyaWJ1dG9yX2NoYW5uZWwiOiJCQSIsInN1aXRhYmlsaXR5X2RlbGVnYXRlZCI6Ik4iLCJsaWNlbnNlcyI6W3sic3RhdGUiOiJBTCIsIm51bWJlciI6IjQ4MjE1NiIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA2LTMwIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiQVIiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJSIiwiaXNzdWVkIjoiMjAwOS0wOC0xNiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkFaIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTEzIiwiZXhwaXJlcyI6IjIwMjYtMDgtMzEifSx7InN0YXRlIjoiQ08iLCJudW1iZXIiOiIzODExMjIiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0yOSIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkNUIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTEwIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiREMiLCJudW1iZXIiOiIzMDQyOTM5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTMtMDMtMjAiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJERSIsIm51bWJlciI6IjExOTY0MDAiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMCIsImV4cGlyZXMiOiIyMDIzLTAyLTI4In0seyJzdGF0ZSI6IkZMIiwibnVtYmVyIjoiVzEwMDU1NCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA2LTE5IiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiR0EiLCJudW1iZXIiOiIyODAyMDI3IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJISSIsIm51bWJlciI6IjQ3MDAwNyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDE4LTAzLTE1IiwiZXhwaXJlcyI6IjIwMjQtMDgtMTYifSx7InN0YXRlIjoiSUEiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDUiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJJRCIsIm51bWJlciI6IjQwODE4OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA0LTE2IiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiSUwiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDQtMDEtMDIiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJJTiIsIm51bWJlciI6Ijc2NTQzNSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTI3IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiS1MiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJLWSIsIm51bWJlciI6IkRPSS03NTc4MjMiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNyIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkxBIiwibnVtYmVyIjoiMzEyNDEzIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDQtMDEtMjYiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJNQSIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxOC0xMC0yNCIsImV4cGlyZXMiOiIyMDI0LTA4LTE1In0seyJzdGF0ZSI6Ik1EIiwibnVtYmVyIjoiMjA3MTE1MCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTIyIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiTUUiLCJudW1iZXIiOiJQUk4yMDI5OTEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMSIsImV4cGlyZXMiOiIwMDAwLTAwLTAwIn0seyJzdGF0ZSI6Ik1JIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTE0IiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiTU4iLCJudW1iZXIiOiI0MDI1NTAzMiIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTI2IiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTU8iLCJudW1iZXIiOiI4MDc0OTA4IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDYtMzAiLCJleHBpcmVzIjoiMjAyMy0wOC0xNSJ9LHsic3RhdGUiOiJNUyIsIm51bWJlciI6IjEwMTA0OTMzIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDktMTAtMjciLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJNVCIsIm51bWJlciI6Ijc1OTUyOSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTEwIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTkMiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMDAwMC0wMC0wMCJ9LHsic3RhdGUiOiJORCIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMyIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6Ik5FIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDA0LTAxLTEyIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTkgiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTAiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJOSiIsIm51bWJlciI6IjEzNzk1NDEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMCIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6Ik5NIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTI5IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiTlYiLCJudW1iZXIiOiI3Njc5MDgiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wOC0wOCIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6Ik5ZIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIwMDAwLTAwLTAwIiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiTlkiLCJudW1iZXIiOiJMQS0xMjI3MjY1IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMjItMDgtMTYiLCJleHBpcmVzIjoiMjAyNC0wOC0xNSJ9LHsic3RhdGUiOiJPSCIsIm51bWJlciI6IjkzNTY3MyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTIyIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiT0siLCJudW1iZXIiOiI3NTIwMCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDA0LTAxLTA1IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiT1IiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMjEiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJQQSIsIm51bWJlciI6IjYwOTM3NSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTEzIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiUkkiLCJudW1iZXIiOiIyMTYxOTQwIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTQiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJTQyIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlNEIiwibnVtYmVyIjoiNDAxNzI5NTgiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlROIiwibnVtYmVyIjoiMjAzNDkzNSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA2LTMwIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiVFgiLCJudW1iZXIiOiIxMjYwNTU4IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDMtMTItMjkiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJVVCIsIm51bWJlciI6IjM4Mjk4MSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTE5IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiVkEiLCJudW1iZXIiOiI4MDg4OTUiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNyIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlZUIiwibnVtYmVyIjoiODE4NTMxIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTIiLCJleHBpcmVzIjoiMjAyMy0wMy0zMSJ9LHsic3RhdGUiOiJXQSIsIm51bWJlciI6IjgwMDM2NyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTEyLTE2IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiV0kiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMjkiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJXViIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMSIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6IldZIiwibnVtYmVyIjoiMjEzNTMyIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMTkiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJDQSIsIm51bWJlciI6IjBINTkxMDEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0xMC0wMyIsImV4cGlyZXMiOiIyMDIzLTEwLTMxIn1dLCJhcHBvaW50bWVudHMiOlt7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkFMIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJBUiIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDYtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiQVoiLCJsb2EiOiJub19sb2EiLCJhcHBvaW50ZWQiOiIyMDE3LTA5LTA4IiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiQ0EiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkNPIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxOC0wMy0yNyIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkZMIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTUiLCJyZW5ld2FsIjoiMjAyMy0wMy0yMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJHQSIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMi0xMi0zMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJQSIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMTAtMTYiLCJyZW5ld2FsIjoiMjAyMi0xMi0zMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJTCIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJTiIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJLUyIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJLWSIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDMtMzEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTEEiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1EIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1JIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJNTiIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTU8iLCJsb2EiOiJub19sb2EiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTkMiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA0LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5FIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5KIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wOS0wOCIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5NIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wNC0zMCIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJPSCIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDctMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiT0siLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIyLTEyLTMxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik9SIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlBBIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlNDIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wOS0wOCIsInJlbmV3YWwiOiIyMDIzLTA5LTMwIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlROIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlRYIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJVVCIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiVkEiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA2LTMwIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IldBIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTExIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IldJIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJXViIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDYtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiV1kiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTAzLTMxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1BIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMjAtMDUtMDEiLCJyZW5ld2FsIjoiMjAyMy0wNy0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH1dfV0");

		// decode the attributes retrieved from the assertion
		final Map<String, String> decodedAttributesMap = this.decode(encodedAttributesMap);

		Logger.debug(this, () -> "Retrieving attributes: " + decodedAttributesMap);
		// Use the hardcoded user to login
		final User user = this.loginWithDefaultUser(httpServletRequest, httpServletResponse);

		Logger.debug(this, ()-> "Resolved user: " + user);
		Logger.debug(this, ()-> "LoginPath: " + successPath);

		// forward to the success path
		httpServletRequest.getSession().setAttribute("samlAttributes", decodedAttributesMap);
		final URI uri = UriBuilder.fromUri(successPath).build();
		return Response.seeOther( uri ).build();
	}

	@POST
	@Path("/benchmark/{idpConfigId}")
	@Consumes({MediaType.APPLICATION_XML, MediaType.APPLICATION_FORM_URLENCODED})
	@Produces( { MediaType.APPLICATION_XML, "text/html" } )
	@NoCache
	public Response processAssertion(@PathParam( "idpConfigId" ) final String idpConfigId,
							 @Context final HttpServletRequest httpServletRequest,
							 @Context final HttpServletResponse httpServletResponse) throws IOException, ServletException {

		if (DotSamlProxyFactory.getInstance().isAnyHostConfiguredAsSAML()) {

			final IdentityProviderConfiguration identityProviderConfiguration =
					this.identityProviderConfigurationFactory.findIdentityProviderConfigurationById(idpConfigId);
			try {

				// If idpConfig is null, means this site does not need SAML processing
				if (identityProviderConfiguration != null && identityProviderConfiguration.isEnabled()) {

					Logger.debug(this, () -> "Processing saml request for idpConfig id: " + idpConfigId);

					// Extracts data from the assertion - if it can't process a DotSamlException is thrown
					final Map<String, String> encodedAttributesMap = this.getSAMLAttributes(httpServletRequest,
							httpServletResponse, identityProviderConfiguration);

					if (null == encodedAttributesMap) {

						Logger.debug(this, () -> "User cannot be extracted from Assertion!");
						throw new DotSamlException("User cannot be extracted from Assertion!");
					}
					// decode the attributes retrieved from the assertion
					final Map<String, String> decodedAttributesMap = this.decode(encodedAttributesMap);
					final String relayState = httpServletRequest.getParameter("RelayState");
					if (UtilMethods.isSet(relayState) && relayState.contains("&")) {
						final String [] relayStateParams = relayState.split("&");
						for (final String relayStateParam : relayStateParams) {
							if (relayStateParam.contains("=")) {
								final String[] relayStateParamKeyValue = relayStateParam.split("=");
								if (relayStateParamKeyValue.length == 2) {
									decodedAttributesMap.put(relayStateParamKeyValue[0], relayStateParamKeyValue[1]);
								}
							}
						}
					}

					Logger.debug(this, () -> "Retrieving attributes: " + decodedAttributesMap);
					// Use the hardcoded user to login
					final User user = this.loginWithDefaultUser(httpServletRequest, httpServletResponse);

					Logger.debug(this, ()-> "Resolved user: " + user);
					Logger.debug(this, ()-> "LoginPath: " + successPath);

					// forward to the success path
					httpServletRequest.getSession().setAttribute("samlAttributes", decodedAttributesMap);
					final URI uri = UriBuilder.fromUri(successPath).build();
					return Response.seeOther( uri ).build();
				}
			} finally {
				if (null != identityProviderConfiguration) {
					identityProviderConfiguration.destroy();
				}
			}
		}

		final String message = "No idpConfig for idpConfigId: " + idpConfigId + ". At " + httpServletRequest.getRequestURI();
		Logger.debug( this, ()-> message);
		throw new DotSamlException(message);
	}

	private User loginWithDefaultUser(final HttpServletRequest request,
									  final HttpServletResponse response) {

		if (APILocator.getLoginServiceAPI().doCookieLogin(EncryptorFactory.getInstance()
				.getEncryptor().encryptString(this.benchmarkUserId), request, response)) {

			final HttpSession session = request.getSession(false);
			if (null != session) {
				return (User)session.getAttribute(WebKeys.CMS_USER);
			}
		}

		throw new DotSamlException("Benchmark User cannot be logged in!");
	}

	private Map<String, String> decode(Map<String, String> encodedAttributesMap) {

		final String contracts    = encodedAttributesMap.get("contracts");
		final byte[] decodedBytes = Base64.getDecoder().decode(contracts);
		final Map<String, String> decodedMap = new HashMap<>(encodedAttributesMap);
		decodedMap.put("contracts", new String(decodedBytes, StandardCharsets.UTF_8));
		return decodedMap;
	}

	private Map<String, String> getSAMLAttributes(final HttpServletRequest httpServletRequest,
												  final HttpServletResponse httpServletResponse,
												  final IdentityProviderConfiguration identityProviderConfiguration) {


		final  Map<String, String> attributeMap = samlAuthenticationService.resolveAllAttributes(
				httpServletRequest, httpServletResponse, identityProviderConfiguration);

		return attributeMap;
		/*return CollectionsUtils.map("npn", "5323749_",
				"role","agent",
				"email", "thebestuser@example.com",
				"contracts", "W3siY29udHJhY3RfaWQiOiIzMDI5MjgiLCJhZ2VudF9pZCI6MiwibnBuIjoiNTMyMzc0OV8iLCJlbWFpbCI6InRoZWJlc3R1c2VyQGV4YW1wbGUuY29tIiwiZm5hbWUiOiJKb2huIiwibG5hbWUiOiJEb2UiLCJuYW1lIjoiSm9obiBEb2UiLCJhZ2VuY3lfbmFtZSI6IiIsInByb2R1Y3RzIjpbMTQzLDE0NCwxMjkxMF0sInByaW5jaXBhbF9pZCI6MCwidHJhaW5pbmdzIjpbeyJ0cmFpbmluZ190eXBlIjoiTElGRVBSIiwic3RhdGUiOiJOWSIsImNvbXBsZXRlZCI6IjIwMjMtMDYtMjYiLCJleHBpcmF0aW9uIjoiMDAwMC0wMC0wMCIsImluc2VydGVkIjoiMjAyMy0wNi0yNiAwNzo0NDoyMiIsInVwZGF0ZWQiOiIyMDIzLTA2LTI2In0seyJ0cmFpbmluZ190eXBlIjoiU1VJVCIsInN0YXRlIjoiTlkiLCJjb21wbGV0ZWQiOiIyMDIzLTA2LTI2IiwiZXhwaXJhdGlvbiI6IjAwMDAtMDAtMDAiLCJpbnNlcnRlZCI6IjIwMjMtMDYtMjYgMDc6NDQ6MzgiLCJ1cGRhdGVkIjoiMjAyMy0wNi0yNiJ9LHsidHJhaW5pbmdfdHlwZSI6IlNVSVRfTlkiLCJzdGF0ZSI6Ik5ZIiwiY29tcGxldGVkIjoiMjAyMy0wNi0yNiIsImV4cGlyYXRpb24iOiIwMDAwLTAwLTAwIiwiaW5zZXJ0ZWQiOiIyMDIzLTA2LTI2IDA3OjQ0OjM4IiwidXBkYXRlZCI6IjIwMjMtMDYtMjYifV0sIndyaXRpbmdfbnVtYmVycyI6W3siY29tcGFueSI6OTIsImFnZW5jeV9jb2RlIjoiTUE5NSIsIndyaXRpbmciOiJCTUE5NTg5OTkiLCJzdGF0dXMiOiJBQ1QiLCJ0eXBlIjoiUEEiLCJkZWFsX2NvZGUiOiIiLCJsZXZlbF9jbGlmZiI6IiJ9LHsiY29tcGFueSI6OTAsImFnZW5jeV9jb2RlIjoiTUE5NSIsIndyaXRpbmciOiJCTUE5NTg5OTkiLCJzdGF0dXMiOiJBQ1QiLCJ0eXBlIjoiUEEiLCJkZWFsX2NvZGUiOiIiLCJsZXZlbF9jbGlmZiI6IiJ9XSwiYWRkcmVzc19saW5lMSI6IjEyMyBNYWluIFN0IiwiYWRkcmVzc19jaXR5IjoiSG90IFNwcmluZ3MiLCJhZGRyZXNzX3N0YXRlIjoiQVIiLCJhZGRyZXNzX3ppcCI6IjcxOTAxIiwid29ya19waG9uZSI6IjgwMDEyMzQ1NjciLCJjZWxsX3Bob25lIjoiODAwNzY1NDMyMSIsImZheF9waG9uZSI6IiIsIm9yaWdpbl9jb2RlIjoiIiwiZGlzdHJpYnV0aW9uX2NvZGUiOiJCQSIsImRpc3RyaWJ1dG9yX2NoYW5uZWwiOiJCQSIsInN1aXRhYmlsaXR5X2RlbGVnYXRlZCI6Ik4iLCJsaWNlbnNlcyI6W3sic3RhdGUiOiJBTCIsIm51bWJlciI6IjQ4MjE1NiIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA2LTMwIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiQVIiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJSIiwiaXNzdWVkIjoiMjAwOS0wOC0xNiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkFaIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTEzIiwiZXhwaXJlcyI6IjIwMjYtMDgtMzEifSx7InN0YXRlIjoiQ08iLCJudW1iZXIiOiIzODExMjIiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0yOSIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkNUIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTEwIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiREMiLCJudW1iZXIiOiIzMDQyOTM5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTMtMDMtMjAiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJERSIsIm51bWJlciI6IjExOTY0MDAiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMCIsImV4cGlyZXMiOiIyMDIzLTAyLTI4In0seyJzdGF0ZSI6IkZMIiwibnVtYmVyIjoiVzEwMDU1NCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA2LTE5IiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiR0EiLCJudW1iZXIiOiIyODAyMDI3IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJISSIsIm51bWJlciI6IjQ3MDAwNyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDE4LTAzLTE1IiwiZXhwaXJlcyI6IjIwMjQtMDgtMTYifSx7InN0YXRlIjoiSUEiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDUiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJJRCIsIm51bWJlciI6IjQwODE4OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA0LTE2IiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiSUwiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDQtMDEtMDIiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJJTiIsIm51bWJlciI6Ijc2NTQzNSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTI3IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiS1MiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJLWSIsIm51bWJlciI6IkRPSS03NTc4MjMiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNyIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IkxBIiwibnVtYmVyIjoiMzEyNDEzIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDQtMDEtMjYiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJNQSIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxOC0xMC0yNCIsImV4cGlyZXMiOiIyMDI0LTA4LTE1In0seyJzdGF0ZSI6Ik1EIiwibnVtYmVyIjoiMjA3MTE1MCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTIyIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiTUUiLCJudW1iZXIiOiJQUk4yMDI5OTEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMSIsImV4cGlyZXMiOiIwMDAwLTAwLTAwIn0seyJzdGF0ZSI6Ik1JIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTE0IiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiTU4iLCJudW1iZXIiOiI0MDI1NTAzMiIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTI2IiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTU8iLCJudW1iZXIiOiI4MDc0OTA4IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDYtMzAiLCJleHBpcmVzIjoiMjAyMy0wOC0xNSJ9LHsic3RhdGUiOiJNUyIsIm51bWJlciI6IjEwMTA0OTMzIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDktMTAtMjciLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJNVCIsIm51bWJlciI6Ijc1OTUyOSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTEwIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTkMiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMDYiLCJleHBpcmVzIjoiMDAwMC0wMC0wMCJ9LHsic3RhdGUiOiJORCIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMyIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6Ik5FIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDA0LTAxLTEyIiwiZXhwaXJlcyI6IjIwMjQtMDgtMzEifSx7InN0YXRlIjoiTkgiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTAiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJOSiIsIm51bWJlciI6IjEzNzk1NDEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMi0wNS0xMCIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6Ik5NIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDEyLTA1LTI5IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiTlYiLCJudW1iZXIiOiI3Njc5MDgiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wOC0wOCIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6Ik5ZIiwibnVtYmVyIjoiNTMyMzc0OSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIwMDAwLTAwLTAwIiwiZXhwaXJlcyI6IjAwMDAtMDAtMDAifSx7InN0YXRlIjoiTlkiLCJudW1iZXIiOiJMQS0xMjI3MjY1IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMjItMDgtMTYiLCJleHBpcmVzIjoiMjAyNC0wOC0xNSJ9LHsic3RhdGUiOiJPSCIsIm51bWJlciI6IjkzNTY3MyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTIyIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiT0siLCJudW1iZXIiOiI3NTIwMCIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDA0LTAxLTA1IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiT1IiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMjEiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJQQSIsIm51bWJlciI6IjYwOTM3NSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTEzIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiUkkiLCJudW1iZXIiOiIyMTYxOTQwIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTQiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJTQyIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlNEIiwibnVtYmVyIjoiNDAxNzI5NTgiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMiIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlROIiwibnVtYmVyIjoiMjAzNDkzNSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA2LTMwIiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiVFgiLCJudW1iZXIiOiIxMjYwNTU4IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMDMtMTItMjkiLCJleHBpcmVzIjoiMjAyNC0wOC0zMSJ9LHsic3RhdGUiOiJVVCIsIm51bWJlciI6IjM4Mjk4MSIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTA3LTE5IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiVkEiLCJudW1iZXIiOiI4MDg4OTUiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0wNyIsImV4cGlyZXMiOiIyMDI0LTA4LTMxIn0seyJzdGF0ZSI6IlZUIiwibnVtYmVyIjoiODE4NTMxIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTItMDUtMTIiLCJleHBpcmVzIjoiMjAyMy0wMy0zMSJ9LHsic3RhdGUiOiJXQSIsIm51bWJlciI6IjgwMDM2NyIsInJlc2lkZW50IjoiTlIiLCJpc3N1ZWQiOiIyMDExLTEyLTE2IiwiZXhwaXJlcyI6IjIwMjMtMDgtMzEifSx7InN0YXRlIjoiV0kiLCJudW1iZXIiOiI1MzIzNzQ5IiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMjkiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJXViIsIm51bWJlciI6IjUzMjM3NDkiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0wNy0xMSIsImV4cGlyZXMiOiIyMDIzLTA4LTMxIn0seyJzdGF0ZSI6IldZIiwibnVtYmVyIjoiMjEzNTMyIiwicmVzaWRlbnQiOiJOUiIsImlzc3VlZCI6IjIwMTEtMDctMTkiLCJleHBpcmVzIjoiMjAyMy0wOC0zMSJ9LHsic3RhdGUiOiJDQSIsIm51bWJlciI6IjBINTkxMDEiLCJyZXNpZGVudCI6Ik5SIiwiaXNzdWVkIjoiMjAxMS0xMC0wMyIsImV4cGlyZXMiOiIyMDIzLTEwLTMxIn1dLCJhcHBvaW50bWVudHMiOlt7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkFMIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJBUiIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDYtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiQVoiLCJsb2EiOiJub19sb2EiLCJhcHBvaW50ZWQiOiIyMDE3LTA5LTA4IiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiQ0EiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkNPIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxOC0wMy0yNyIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IkZMIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTUiLCJyZW5ld2FsIjoiMjAyMy0wMy0yMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJHQSIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMi0xMi0zMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJQSIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMTAtMTYiLCJyZW5ld2FsIjoiMjAyMi0xMi0zMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJTCIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJJTiIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJLUyIsImxvYSI6Im5vX2xvYSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJLWSIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDMtMzEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTEEiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1EIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1JIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJNTiIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTU8iLCJsb2EiOiJub19sb2EiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiTkMiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA0LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5FIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5KIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wOS0wOCIsInJlbmV3YWwiOiIyMDIzLTA1LTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik5NIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wNC0zMCIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJPSCIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDctMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiT0siLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIyLTEyLTMxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik9SIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlBBIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlNDIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wOS0wOCIsInJlbmV3YWwiOiIyMDIzLTA5LTMwIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlROIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDQ5LTAxLTAxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IlRYIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjA0OS0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJVVCIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwNDktMDEtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiVkEiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA2LTMwIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IldBIiwibG9hIjoibm9fbG9hIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTA1LTExIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6IldJIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMTctMDUtMTEiLCJyZW5ld2FsIjoiMjAyMy0wMS0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH0seyJjb21wYW55Ijo5Miwic3RhdGUiOiJXViIsImxvYSI6ImxpZmUiLCJhcHBvaW50ZWQiOiIyMDE3LTA1LTExIiwicmVuZXdhbCI6IjIwMjMtMDYtMDEiLCJtYW51YWxfYXBwb2ludG1lbnQiOm51bGx9LHsiY29tcGFueSI6OTIsInN0YXRlIjoiV1kiLCJsb2EiOiJsaWZlIiwiYXBwb2ludGVkIjoiMjAxNy0wNS0xMSIsInJlbmV3YWwiOiIyMDIzLTAzLTMxIiwibWFudWFsX2FwcG9pbnRtZW50IjpudWxsfSx7ImNvbXBhbnkiOjkyLCJzdGF0ZSI6Ik1BIiwibG9hIjoibGlmZSIsImFwcG9pbnRlZCI6IjIwMjAtMDUtMDEiLCJyZW5ld2FsIjoiMjAyMy0wNy0wMSIsIm1hbnVhbF9hcHBvaW50bWVudCI6bnVsbH1dfV0");*/
	}

}
